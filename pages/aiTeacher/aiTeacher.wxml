import mp-html from 'mp-html/index.js'
<view class="chat-container">
  <!-- ËÅäÂ§©ÂÜÖÂÆπÂå∫Âüü -->
  <scroll-view scroll-y="true" class="chat-content" scroll-into-view="{{scrollToMessage}}" >
    <block wx:for="{{messages}}" wx:key="index">
      <view id="message-{{index}}" class="message-wrapper {{item.type === 'user' ? 'user-message' : 'ai-message'}}">
        <view class="message-avatar">
          <view wx:if="{{item.type === 'user'}}" class="avatar-placeholder ">Áî®Êà∑</view>
          <image wx:else class="avatar-placeholder" src="/images/AI_3.png" mode="aspectFill" />
        </view>
        
        <!-- Ê∂àÊÅØÂÜÖÂÆπ -->
        <view class="message-content">
          <block wx:if="{{item.type === 'user'}}">
            <text>{{item.content}}</text>
          </block>
          <block wx:else>
            <!-- AIÂõûÂ§çÂÜÖÂÆπ - Ê†πÊçÆÊòØÂê¶‰∏∫MarkdownÈÄâÊã©‰∏çÂêåÁöÑÊ∏≤ÊüìÊñπÂºè -->
            <view class="ai-content">
              <!-- ‰ΩøÁî®mp-htmlÁªÑ‰ª∂Ê∏≤ÊüìMarkdownÂÜÖÂÆπ -->
              <mp-html wx:if="{{item.isMarkdown}}" content="{{item.content}}" show-img-menu="false" scroll-table="true" copy-link="true" selectable="true" />
              <!-- ÊôÆÈÄöÊñáÊú¨ÂÜÖÂÆπ -->
              <text wx:else>{{item.content}}</text>
            </view>

            <!-- ÊµÅÂºèÂõûÂ§çÁä∂ÊÄÅÊåáÁ§∫ÔºàÂΩì content ‰∏∫Á©∫Êó∂ÊòæÁ§∫Ôºâ -->
            <view wx:if="{{!item.content || item.content === ''}}" class="typing-indicator">
              <view class="typing-dot"></view>
              <view class="typing-dot"></view>
              <view class="typing-dot"></view>
            </view>
            
            <!-- Âú® AI ÂõûÂ§ç‰∏ãÊñπÊòæÁ§∫‰∏â‰∏™‰ø°ÊÅØÊ°Ü -->
            <view class="ai-boxes" wx:if="{{item.boxes && item.boxes.length}}">
              <block wx:for="{{item.boxes}}" wx:for-item="box" wx:for-index="bidx" wx:key="bidx">
                <view class="ai-box" bindtap="onBoxTap" data-msg-index="{{index}}" data-box-index="{{bidx}}">
                  <view class="ai-box-row">
                    <view class="ai-box-icon">üîñ</view>
                    <view class="ai-box-content">
                      <text class="ai-box-key">{{box.key}}</text>
                      <text class="ai-box-value">{{box.value}}</text>
                    </view>
                    <view class="ai-box-arrow">‚Ä∫</view>
                  </view>
                </view>
              </block>
            </view>
            <!-- Â¶ÇÊûú AI ÂõûÂ§ç‰∏≠ÂåÖÂê´ËÄÅÂ∏àÂç°ÁâáÔºåÂàôÊ∏≤ÊüìÂç°ÁâáÂàóË°® -->
            <view class="teacher-cards" wx:if="{{item.teacherCards && item.teacherCards.length}}">
              <block wx:for="{{item.teacherCards}}" wx:for-item="card" wx:for-index="cidx" wx:key="card.id">
                <view class="teacher-card" data-id="{{card.id}}">
                  <image class="teacher-avatar" src="{{card.image_url || '/images/teacher3'}}" mode="aspectFill" />
                  <view class="teacher-info">
                    <text class="teacher-name">{{card.name}}</text>
                    <text class="teacher-subject">{{card.subjects || [].join('„ÄÅ')}}</text>
                    <text class="teacher-desc">{{card.desc || card.experience || ''}}</text>
                    <view class="teacher-actions">
                      <button class="btn-view" data-id="{{card.id}}" bindtap="viewTeacherDetailFromCard">Êü•Áúã</button>
                      <button class="btn-contact" data-id="{{card.id}}" data-name="{{card.name}}" data-price="{{card.price_range || card.price}}" bindtap="contactTeacherFromCard">ËÅîÁ≥ª</button>
                    </view>
                  </view>
                </view>
              </block>
            </view>
          </block>
        </view>
      </view>
    </block>

    <!-- Âä†ËΩΩÁä∂ÊÄÅ -->
    <view wx:if="{{loading}}" class="loading-container">
      <view class="loading-spinner"></view>
      <text class="loading-text">AIÊ≠£Âú®ÊÄùËÄÉ‰∏≠...</text>
    </view>
  </scroll-view>
  
  <!-- ËæìÂÖ•Áî®Êà∑Á±ªÂûã -->
  <van-picker show-toolbar
  title="ËØ∑ÈÄâÊã©ÊÇ®ÁöÑË∫´‰ªΩ"
  wx:if = "{{show}}"
  columns="{{ columns }}"
  default-index="{{ 1 }}"
  bind:confirm ="onConfirm"
  bind:cancel = "onCancel"
  bind:change = "onChange"/>

  <van-toast  id="van-toast" class= "toast-voice" />

  <!-- ËæìÂÖ•Âå∫Âüü -->
  <!-- È¢ÑËÆæÊåâÈíÆÔºàÊ∞¥Âπ≥ÂèØÊªëÂä®Ôºâ -->
  <scroll-view class="preset-bar" scroll-x="true" show-scrollbar="false">
    <view class="preset-list">
      <block wx:for="{{presets}}" wx:for-item="p" wx:for-index="i" wx:key="i">
        <button class="preset-btn {{selectedPreset === i ? 'active' : '' }}" data-index="{{i}}" bindtap="selectPreset">{{p.label}}</button>
      </block>
    </view>
  </scroll-view>
<!-- ËæìÂÖ•ÂÜÖÂÆπÂå∫Âüü -->
  <view class="input-area">
    <textarea 
      class="chat-input" 
      placeholder="ËØ∑ËæìÂÖ•ÂÜÖÂÆπ" 
      value="{{inputContent}}" 
      bindinput="onInputChange" 
      bindconfirm="sendMessage"
      auto-height="true"
      adjust-position="true"
      maxlength="-1"
      show-confirm-bar="false"
      placeholder-style="color:#999"
      cursor-spacing="20"
    />
    <view class="input-actions">
      <button class="voice-btn" bindtouchstart="startVoice" bindtouchend="stopVoice" bindtouchcancel="cancelVoice">
        <image 
          class="voice-icon"
          src="{{isRecording ? '/images/voice_selected.png' : '/images/voice.png'}}"
          mode="aspectFit"
        />
        
      </button>
      <button class="send-btn" bindtap="sendMessage">ÂèëÈÄÅ</button>
    </view>
  </view>
</view>